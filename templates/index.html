<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chatbot ü§ñ</title>
    <style>
        :root {
            /* Light theme */
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #ffecd2, #fcb69f);
            --background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-bg: rgba(255, 255, 255, 0.95);
            --message-user-bg: linear-gradient(135deg, #667eea, #764ba2);
            --message-bot-bg: white;
            --text-primary: #333;
            --text-secondary: #6c757d;
            --border-color: #e9ecef;
            --input-bg: white;
            --suggestion-bg: rgba(102, 126, 234, 0.1);
            --suggestion-color: #667eea;
            --shadow: rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] {
            /* Dark theme */
            --background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            --card-bg: rgba(45, 52, 64, 0.95);
            --message-user-bg: linear-gradient(135deg, #667eea, #764ba2);
            --message-bot-bg: #3c4043;
            --text-primary: #e8eaed;
            --text-secondary: #9aa0a6;
            --border-color: #5f6368;
            --input-bg: #3c4043;
            --suggestion-bg: rgba(102, 126, 234, 0.2);
            --suggestion-color: #8ab4f8;
            --shadow: rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--background);
            height: 100vh;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            color: var(--text-primary);
            overflow: hidden; /* Prevent body scroll */
        }

        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 0.75rem 1rem;
            text-align: center;
            color: white;
            box-shadow: 0 2px 20px var(--shadow);
            position: relative;
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 1.5rem;
            margin-bottom: 0.25rem;
            background: linear-gradient(45deg, #fff, #f0f0f0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .header-controls {
            position: absolute;
            top: 0.75rem;
            right: 1rem;
            display: flex;
            gap: 0.5rem;
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            font-size: 0.9rem;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .container {
            flex: 1;
            max-width: 1000px;
            margin: 0 auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 120px); /* Account for header */
            min-height: 0;
        }

        .chat-container {
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: 0 10px 40px var(--shadow);
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
        }

        .chat-header {
            padding: 0.75rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--card-bg);
            flex-shrink: 0;
        }

        .chat-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #28a745;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .clear-chat-btn {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            border: none;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .clear-chat-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
        }

        .suggestions-container {
            padding: 0.75rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            background: var(--card-bg);
            flex-shrink: 0;
        }

        .suggestions {
            display: flex;
            gap: 0.4rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .suggestion-chip {
            background: var(--suggestion-bg);
            color: var(--suggestion-color);
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(102, 126, 234, 0.2);
            display: flex;
            align-items: center;
            gap: 0.3rem;
            white-space: nowrap;
        }

        .suggestion-chip:hover {
            background: var(--primary-gradient);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px var(--shadow);
        }

        .chat-messages {
            flex: 1;
            padding: 1rem 1.5rem;
            overflow-y: auto;
            scroll-behavior: smooth;
            min-height: 0; /* Important for flex child */
        }

        .message {
            margin-bottom: 1rem;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            animation: fadeInUp 0.3s ease;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            flex-shrink: 0;
            box-shadow: 0 2px 10px var(--shadow);
        }

        .message.user .message-avatar {
            background: var(--message-user-bg);
            color: white;
        }

        .message.bot .message-avatar {
            background: var(--secondary-gradient);
            color: #333;
        }

        .message-content {
            background: var(--input-bg);
            padding: 0.75rem 1rem;
            border-radius: 18px;
            max-width: 75%;
            word-wrap: break-word;
            position: relative;
            box-shadow: 0 2px 10px var(--shadow);
            border: 1px solid var(--border-color);
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .message.user .message-content {
            background: var(--message-user-bg);
            color: white;
            border: none;
        }

        .message.bot .message-content {
            background: var(--message-bot-bg);
            color: var(--text-primary);
        }

        .message-meta {
            font-size: 0.7rem;
            opacity: 0.7;
            margin-top: 0.4rem;
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .confidence-badge {
            background: rgba(0, 123, 255, 0.1);
            color: #007bff;
            padding: 0.15rem 0.4rem;
            border-radius: 8px;
            font-size: 0.65rem;
            font-weight: bold;
        }

        .confidence-high { background: rgba(40, 167, 69, 0.1); color: #28a745; }
        .confidence-medium { background: rgba(255, 193, 7, 0.1); color: #ffc107; }
        .confidence-low { background: rgba(220, 53, 69, 0.1); color: #dc3545; }

        .typing-indicator {
            display: none;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-secondary);
            font-style: italic;
            padding: 0 1.5rem;
            flex-shrink: 0;
        }

        .typing-dots {
            display: flex;
            gap: 0.3rem;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: var(--text-secondary);
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        .chat-input-container {
            padding: 1rem 1.5rem;
            background: var(--card-bg);
            border-top: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .chat-input-form {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .chat-input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: 25px;
            font-size: 0.9rem;
            outline: none;
            transition: all 0.3s ease;
            background: var(--input-bg);
            color: var(--text-primary);
        }

        .chat-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .send-button {
            background: var(--primary-gradient);
            color: white;
            border: none;
            width: 42px;
            height: 42px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px var(--shadow);
            flex-shrink: 0;
        }

        .send-button:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .send-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .welcome-message {
            text-align: center;
            color: var(--text-secondary);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
        }

        .welcome-icon {
            font-size: 3rem;
            animation: bounce 2s infinite;
        }

        .floating-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .particle {
            position: absolute;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            animation: float 6s ease-in-out infinite;
        }

        .message-actions {
            position: absolute;
            bottom: 0.3rem;
            right: 0.5rem;
            opacity: 0;
            transition: opacity 0.3s ease;
            display: flex;
            gap: 0.25rem;
        }

        .message-content:hover .message-actions {
            opacity: 1;
        }

        .action-btn {
            background: rgba(0, 0, 0, 0.1);
            border: none;
            color: var(--text-secondary);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            background: rgba(0, 0, 0, 0.2);
            transform: scale(1.1);
        }

        .stats-bar {
            padding: 0.4rem 1.5rem;
            background: rgba(0, 0, 0, 0.05);
            border-top: 1px solid var(--border-color);
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-align: center;
            flex-shrink: 0;
        }

        .status-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--card-bg);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            box-shadow: 0 2px 10px var(--shadow);
            font-size: 0.8rem;
            display: none;
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            z-index: 1000;
        }

        .status-online { color: #28a745; }
        .status-offline { color: #dc3545; }

        .notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--card-bg);
            padding: 1rem 2rem;
            border-radius: 15px;
            box-shadow: 0 10px 40px var(--shadow);
            display: none;
            z-index: 1001;
            animation: fadeInScale 0.3s ease;
        }

        /* MOBILE RESPONSIVE DESIGN */
        @media (max-width: 768px) {
            body {
                height: 100vh;
                height: 100dvh; /* Dynamic viewport height for mobile */
            }

            .header {
                padding: 0.5rem;
            }

            .header h1 {
                font-size: 1.3rem;
                margin-bottom: 0.2rem;
            }

            .header p {
                font-size: 0.8rem;
            }

            .header-controls {
                top: 0.5rem;
                right: 0.5rem;
                gap: 0.3rem;
            }

            .control-btn {
                width: 30px;
                height: 30px;
                font-size: 0.8rem;
            }

            .container {
                padding: 0.5rem;
                height: calc(100vh - 90px);
                height: calc(100dvh - 90px);
            }

            .chat-container {
                border-radius: 15px;
            }

            .chat-header {
                padding: 0.5rem 1rem;
            }

            .chat-status {
                font-size: 0.75rem;
            }

            .clear-chat-btn {
                padding: 0.3rem 0.6rem;
                font-size: 0.75rem;
            }

            .suggestions-container {
                padding: 0.5rem 1rem;
            }

            .suggestions {
                gap: 0.3rem;
                justify-content: flex-start;
                overflow-x: auto;
                padding-bottom: 0.25rem;
            }

            .suggestion-chip {
                padding: 0.3rem 0.6rem;
                font-size: 0.75rem;
                flex-shrink: 0;
            }

            .chat-messages {
                padding: 0.75rem 1rem;
            }

            .message {
                margin-bottom: 0.75rem;
                gap: 0.5rem;
            }

            .message-avatar {
                width: 30px;
                height: 30px;
                font-size: 0.9rem;
            }

            .message-content {
                max-width: 85%;
                padding: 0.6rem 0.8rem;
                font-size: 0.85rem;
                border-radius: 15px;
            }

            .message-meta {
                font-size: 0.65rem;
                margin-top: 0.3rem;
                gap: 0.5rem;
            }

            .confidence-badge {
                padding: 0.1rem 0.3rem;
                font-size: 0.6rem;
            }

            .chat-input-container {
                padding: 0.75rem 1rem;
            }

            .chat-input-form {
                gap: 0.5rem;
            }

            .chat-input {
                padding: 0.6rem 0.8rem;
                font-size: 0.85rem;
                border-radius: 20px;
            }

            .send-button {
                width: 38px;
                height: 38px;
                font-size: 1rem;
            }

            .stats-bar {
                padding: 0.3rem 1rem;
                font-size: 0.7rem;
            }

            .welcome-message {
                padding: 1rem;
                gap: 0.5rem;
            }

            .welcome-icon {
                font-size: 2.5rem;
            }

            .typing-indicator {
                padding: 0 1rem;
                font-size: 0.8rem;
            }

            .typing-dot {
                width: 5px;
                height: 5px;
            }

            /* Ensure suggestions scroll horizontally on mobile */
            .suggestions {
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                -ms-overflow-style: none;
            }

            .suggestions::-webkit-scrollbar {
                display: none;
            }
        }

        /* EXTRA SMALL SCREENS */
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.2rem;
            }

            .header p {
                font-size: 0.75rem;
            }

            .container {
                padding: 0.25rem;
            }

            .chat-container {
                border-radius: 10px;
            }

            .message-content {
                max-width: 90%;
                font-size: 0.8rem;
            }

            .suggestion-chip {
                font-size: 0.7rem;
                padding: 0.25rem 0.5rem;
            }
        }

        /* Landscape mobile orientation */
        @media (max-height: 500px) and (orientation: landscape) {
            .header {
                padding: 0.4rem;
            }

            .header h1 {
                font-size: 1.2rem;
                margin-bottom: 0;
            }

            .header p {
                display: none; /* Hide subtitle in landscape */
            }

            .container {
                height: calc(100vh - 60px);
                height: calc(100dvh - 60px);
            }

            .suggestions-container {
                padding: 0.4rem 1rem;
            }

            .chat-messages {
                padding: 0.5rem 1rem;
            }

            .welcome-message {
                padding: 0.75rem;
            }

            .welcome-icon {
                font-size: 2rem;
            }
        }

        /* Markdown styling for bot responses */
        .message-content h1, .message-content h2, .message-content h3 {
            margin: 0.4rem 0;
            font-size: 1em;
        }

        .message-content strong {
            font-weight: 600;
        }

        .message-content ul, .message-content ol {
            margin: 0.4rem 0;
            padding-left: 1.2rem;
        }

        .message-content li {
            margin: 0.2rem 0;
        }

        .message-content pre {
            background: rgba(0, 0, 0, 0.05);
            padding: 0.75rem;
            border-radius: 8px;
            overflow-x: auto;
            margin: 0.4rem 0;
            font-size: 0.8rem;
        }

        .message-content code {
            background: rgba(0, 0, 0, 0.05);
            padding: 0.15rem 0.3rem;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85em;
        }

        .stats-table {
            width: 100%;
            border-collapse: collapse;
            margin: 0.75rem 0;
            font-size: 0.8rem;
        }

        .stats-table th, .stats-table td {
            padding: 0.5rem 0.4rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .stats-table th {
            font-weight: 600;
            color: var(--text-primary);
        }

        .stats-table td {
            color: var(--text-secondary);
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(15px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes typing {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1);
            }
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-8px); }
            60% { transform: translateY(-4px); }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            33% { transform: translateY(-15px) rotate(120deg); }
            66% { transform: translateY(15px) rotate(240deg); }
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }
    
/* --- FIXES FOR MOBILE RESPONSIVENESS --- */
body {
  overflow-x: hidden; /* prevent horizontal cut-off */
  overflow-y: auto;   /* allow vertical scroll */
}

.container {
  max-width: 100% !important; /* always fluid width */
}

.message-content {
  max-width: 100% !important; /* allow full width */
  word-break: break-word;     /* break long words on small screens */
}

@media (max-width: 768px) {
  .message-content {
    max-width: 90% !important; /* better fit on mobile */
  }
  .chat-input {
    min-width: 0; /* prevent overflow of input field */
  }
}

</style>
</head>
<body>
    <!-- Floating particles background -->
    <div class="floating-particles" id="particles"></div>

    <div class="header">
        <div class="header-controls">
            <button class="control-btn" onclick="startNewSession()" title="Inizia Nuova Sessione">
                üîÑ
            </button>
            <button class="control-btn" onclick="toggleTheme()" title="Toggle Dark Mode">
                üåô
            </button>
            <button class="control-btn" onclick="showStats()" title="API Statistics">
                üìä
            </button>
        </div>
        <h1>ü§ñ AI Chatbot</h1>
        <p>Il tuo assistente intelligente per meteo, notizie, azioni e molto altro!</p>
    </div>

    <div class="container">
        <div class="chat-container">
            <!-- Chat Header -->
            <div class="chat-header">
                <div class="chat-status">
                    <div class="status-dot"></div>
                    <span>AI Assistant Online</span>
                </div>
                <button class="clear-chat-btn" onclick="clearChat()">
                    üóëÔ∏è Pulisci Chat
                </button>
            </div>

            <!-- Suggestions Bar - Always Visible -->
            <div class="suggestions-container">
                <div class="suggestions" id="mainSuggestions">
                    <div class="suggestion-chip" onclick="sendSuggestion('Che tempo fa?')">
                        üå§Ô∏è Meteo
                    </div>
                    <div class="suggestion-chip" onclick="sendSuggestion('Ultime notizie')">
                        üì∞ Notizie
                    </div>
                    <div class="suggestion-chip" onclick="sendSuggestion('Prezzi azioni')">
                        üìà Borsa
                    </div>
                    <div class="suggestion-chip" onclick="sendSuggestion('Crypto prezzi')">
                        ‚Çø Crypto
                    </div>
                    <div class="suggestion-chip" onclick="sendSuggestion('Mostra todo')">
                        üìù Todo
                    </div>
                    <div class="suggestion-chip" onclick="sendSuggestion('Raccontami una barzelletta')">
                        üòÑ Fun
                    </div>
                    <div class="suggestion-chip" onclick="sendSuggestion('Che ora √®?')">
                        üïê Ora
                    </div>
                    <div class="suggestion-chip" onclick="sendSuggestion('Aiuto')">
                        ‚ùì Aiuto
                    </div>
                </div>
            </div>

            <!-- Chat Messages -->
            <div class="chat-messages" id="chatMessages">
                <div class="welcome-message">
                    <div class="welcome-icon">ü§ñ</div>
                    <h2>Benvenuto!</h2>
                    <p>Sono il tuo AI Assistant potenziato! Usa i pulsanti sopra per iniziare rapidamente.</p>
                </div>
            </div>

            <!-- Typing Indicator -->
            <div class="typing-indicator" id="typingIndicator">
                <span>ü§ñ AI sta scrivendo</span>
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>

            <!-- Chat Input -->
            <div class="chat-input-container">
                <form class="chat-input-form" onsubmit="sendMessage(event)">
                    <button type="button" class="send-button" onclick="toggleVoiceInput()" title="Registra messaggio vocale" style="background: linear-gradient(135deg, #ff6b6b, #ee5a52);">
                        üé§
                    </button>
                    <input 
                        type="text" 
                        class="chat-input" 
                        id="messageInput" 
                        placeholder="Scrivi il tuo messaggio..." 
                        autocomplete="off"
                        maxlength="500"
                    >
                    <button type="submit" class="send-button" id="sendButton">
                        ‚û§
                    </button>
                </form>
            </div>

            <!-- Stats Bar -->
            <div class="stats-bar" id="statsBar">
                üí¨ Messaggi: <span id="messageCount">0</span> | 
                ‚è±Ô∏è Sessione: <span id="sessionTime">00:00</span>
            </div>
        </div>
    </div>

    <!-- Status Indicator -->
    <div class="status-indicator" id="statusIndicator">
        <span id="statusText">üü¢ Online</span>
    </div>

    <!-- Notification Modal -->
    <div class="notification" id="notification">
        <span id="notificationText"></span>
    </div>

    <script>
        let isFirstMessage = true;
        let messageCount = 0;
        let sessionStartTime = Date.now();
        let currentTheme = 'light';

        // Initialize particles
        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            const particleCount = window.innerWidth < 768 ? 10 : 20; // Fewer particles on mobile
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                particle.style.width = particle.style.height = Math.random() * 4 + 2 + 'px';
                particle.style.animationDelay = Math.random() * 6 + 's';
                particle.style.animationDuration = (Math.random() * 3 + 3) + 's';
                particlesContainer.appendChild(particle);
            }
        }

        // Toggle theme
        function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', currentTheme);
            
            const themeBtn = document.querySelectorAll('.control-btn')[1]; // Second button is theme
            themeBtn.textContent = currentTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
            
            showNotification(`Modalit√† ${currentTheme === 'dark' ? 'Scura' : 'Chiara'} attivata`);
            localStorage.setItem('theme', currentTheme);
        }

        // Load saved theme
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            currentTheme = savedTheme;
            document.documentElement.setAttribute('data-theme', currentTheme);
            
            const themeBtn = document.querySelectorAll('.control-btn')[1]; // Second button is theme
            themeBtn.textContent = currentTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
        }

        // Clear chat function with beautiful confirmation modal
        function clearChat() {
            // Create modal for confirmation
            const modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0,0,0,0.7)';
            modal.style.display = 'flex';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';
            modal.style.zIndex = '2000';
            
            // Modal content
            const modalContent = document.createElement('div');
            modalContent.style.background = 'var(--card-bg)';
            modalContent.style.padding = '2rem';
            modalContent.style.borderRadius = '15px';
            modalContent.style.boxShadow = '0 10px 30px rgba(0,0,0,0.2)';
            modalContent.style.maxWidth = '400px';
            modalContent.style.width = '90%';
            modalContent.style.textAlign = 'center';
            
            // Title
            const title = document.createElement('h3');
            title.textContent = 'üóëÔ∏è Pulisci Chat';
            title.style.marginBottom = '1rem';
            title.style.color = 'var(--text-primary)';
            
            // Message
            const message = document.createElement('p');
            message.textContent = 'Sei sicuro di voler cancellare tutta la conversazione?';
            message.style.marginBottom = '2rem';
            message.style.color = 'var(--text-secondary)';
            
            // Buttons container
            const buttonsContainer = document.createElement('div');
            buttonsContainer.style.display = 'flex';
            buttonsContainer.style.gap = '1rem';
            buttonsContainer.style.justifyContent = 'center';
            
            // Cancel button
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'Annulla';
            cancelBtn.style.padding = '0.75rem 1.5rem';
            cancelBtn.style.border = '1px solid var(--border-color)';
            cancelBtn.style.background = 'transparent';
            cancelBtn.style.color = 'var(--text-secondary)';
            cancelBtn.style.borderRadius = '8px';
            cancelBtn.style.cursor = 'pointer';
            cancelBtn.style.transition = 'all 0.3s ease';
            cancelBtn.onmouseover = () => {
                cancelBtn.style.background = 'rgba(0,0,0,0.05)';
            };
            cancelBtn.onmouseout = () => {
                cancelBtn.style.background = 'transparent';
            };
            cancelBtn.onclick = () => document.body.removeChild(modal);
            
            // Confirm button
            const confirmBtn = document.createElement('button');
            confirmBtn.textContent = 'S√¨, cancella';
            confirmBtn.style.padding = '0.75rem 1.5rem';
            confirmBtn.style.border = 'none';
            confirmBtn.style.background = 'linear-gradient(135deg, #ff6b6b, #ee5a52)';
            confirmBtn.style.color = 'white';
            confirmBtn.style.borderRadius = '8px';
            confirmBtn.style.cursor = 'pointer';
            confirmBtn.style.transition = 'all 0.3s ease';
            confirmBtn.onmouseover = () => {
                confirmBtn.style.transform = 'translateY(-2px)';
                confirmBtn.style.boxShadow = '0 5px 15px rgba(255, 107, 107, 0.3)';
            };
            confirmBtn.onmouseout = () => {
                confirmBtn.style.transform = 'translateY(0)';
                confirmBtn.style.boxShadow = 'none';
            };
            
            //calls backend to clean the conversation DB
            confirmBtn.onclick = async () => {
                try {
                    const response = await fetch('/clear-chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });
                    
                    if (response.ok) {
                        // clean also Front End
                        const chatMessages = document.getElementById('chatMessages');
                        chatMessages.innerHTML = `
                            <div class="welcome-message">
                                <div class="welcome-icon">ü§ñ</div>
                                <h2>Chat Pulita!</h2>
                                <p>Inizia una nuova conversazione usando i pulsanti sopra.</p>
                            </div>
                        `;
                        messageCount = 0;
                        updateStats();
                        isFirstMessage = true;
                        showNotification('Chat cancellata definitivamente! üóëÔ∏è');
                    } else {
                        showNotification('‚ùå Errore nella cancellazione');
                    }
                } catch (error) {
                    console.error('Errore nel pulire la chat:', error);
                    showNotification('‚ùå Errore di connessione');
                }
                
                document.body.removeChild(modal);
            };
            
            // Assemble modal
            buttonsContainer.appendChild(cancelBtn);
            buttonsContainer.appendChild(confirmBtn);
            
            modalContent.appendChild(title);
            modalContent.appendChild(message);
            modalContent.appendChild(buttonsContainer);
            
            modal.appendChild(modalContent);
            
            // Make it closable by clicking outside
            modal.onclick = (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            };
            
            document.body.appendChild(modal);
        }

        // to start a new clear session
        async function startNewSession() {
            try {
                const response = await fetch('/new-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // clear the display
                    const chatMessages = document.getElementById('chatMessages');
                    chatMessages.innerHTML = `
                        <div class="welcome-message">
                            <div class="welcome-icon">ü§ñ</div>
                            <h2>Benvenuto!</h2>
                            <p>Sono il tuo AI Assistant potenziato! Usa i pulsanti sopra per iniziare rapidamente.</p>
                        </div>
                    `;
                    
                    // Reset counters
                    messageCount = 0;
                    sessionStartTime = Date.now();
                    isFirstMessage = true;
                    updateStats();
                    
                    showNotification('Nuova sessione avviata! üéâ');
                } else {
                    showNotification('‚ùå Errore nell\'avvio nuova sessione');
                }
            } catch (error) {
                console.error('Errore nuova sessione:', error);
                showNotification('‚ùå Errore di connessione');
            }
        }

        // Show API statistics in a modal
        async function showStats() {
            try {
                const response = await fetch('/api-stats');
                const data = await response.json();
                
                // Create modal for stats
                const modal = document.createElement('div');
                modal.style.position = 'fixed';
                modal.style.top = '0';
                modal.style.left = '0';
                modal.style.width = '100%';
                modal.style.height = '100%';
                modal.style.backgroundColor = 'rgba(0,0,0,0.7)';
                modal.style.display = 'flex';
                modal.style.justifyContent = 'center';
                modal.style.alignItems = 'center';
                modal.style.zIndex = '2000';
                
                // Stats content
                const statsContent = document.createElement('div');
                statsContent.style.background = 'var(--card-bg)';
                statsContent.style.padding = '2rem';
                statsContent.style.borderRadius = '15px';
                statsContent.style.boxShadow = '0 10px 30px rgba(0,0,0,0.2)';
                statsContent.style.maxWidth = '500px';
                statsContent.style.width = '90%';
                statsContent.style.maxHeight = '80vh';
                statsContent.style.overflowY = 'auto';
                
                // Close button
                const closeBtn = document.createElement('button');
                closeBtn.textContent = '‚úï';
                closeBtn.style.position = 'absolute';
                closeBtn.style.top = '10px';
                closeBtn.style.right = '10px';
                closeBtn.style.background = 'none';
                closeBtn.style.border = 'none';
                closeBtn.style.fontSize = '1.5rem';
                closeBtn.style.cursor = 'pointer';
                closeBtn.style.color = 'var(--text-primary)';
                closeBtn.onclick = () => document.body.removeChild(modal);
                
                // Title
                const title = document.createElement('h2');
                title.textContent = 'üìä Statistiche API';
                title.style.marginBottom = '1.5rem';
                title.style.textAlign = 'center';
                title.style.color = 'var(--text-primary)';
                
                statsContent.appendChild(title);
                
                // Stats table
                const table = document.createElement('table');
                table.style.width = '100%';
                table.style.borderCollapse = 'collapse';
                
                let statsHTML = `
                    <tr style="border-bottom: 1px solid var(--border-color)">
                        <th style="text-align: left; padding: 0.5rem">API</th>
                        <th style="text-align: center; padding: 0.5rem">Utilizzate</th>
                        <th style="text-align: center; padding: 0.5rem">Limite</th>
                        <th style="text-align: center; padding: 0.5rem">Rimanenti</th>
                    </tr>
                `;
                
                for (const [api, stats] of Object.entries(data.api_usage)) {
                    statsHTML += `
                        <tr style="border-bottom: 1px solid var(--border-color)">
                            <td style="padding: 0.75rem 0.5rem">${api}</td>
                            <td style="text-align: center; padding: 0.75rem 0.5rem">${stats.used}</td>
                            <td style="text-align: center; padding: 0.75rem 0.5rem">${stats.limit}</td>
                            <td style="text-align: center; padding: 0.75rem 0.5rem">${stats.remaining}</td>
                        </tr>
                    `;
                }
                
                table.innerHTML = statsHTML;
                statsContent.appendChild(table);
                statsContent.appendChild(closeBtn);
                modal.appendChild(statsContent);
                
                // Add to document and make it closable by clicking outside
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                    }
                };
                
                document.body.appendChild(modal);
            } catch (error) {
                showNotification('‚ùå Errore nel caricamento statistiche');
            }
        }

        // Show notification
        function showNotification(message) {
            const notification = document.getElementById('notification');
            const text = document.getElementById('notificationText');
            text.textContent = message;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 2000);
        }

        // Update session stats
        function updateStats() {
            document.getElementById('messageCount').textContent = messageCount;
            
            const elapsed = Date.now() - sessionStartTime;
            const minutes = Math.floor(elapsed / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            document.getElementById('sessionTime').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function formatResponse(text) {
            // Convert basic markdown to HTML
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
            text = text.replace(/\n\n/g, '<br><br>');
            text = text.replace(/\n/g, '<br>');
            
            // Convert emoji shortcuts
            text = text.replace(/:\)/g, 'üòä');
            text = text.replace(/:\(/g, 'üò¢');
            text = text.replace(/:D/g, 'üòÑ');
            
            return text;
        }

        function getConfidenceClass(confidence) {
            if (confidence >= 80) return 'confidence-high';
            if (confidence >= 60) return 'confidence-medium';
            return 'confidence-low';
        }

        function addMessage(message, isUser, intent = '', confidence = 0) {
            const chatMessages = document.getElementById('chatMessages');
            
            if (isFirstMessage && isUser) {
                chatMessages.innerHTML = '';
                isFirstMessage = false;
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'bot'}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = isUser ? 'üë§' : 'ü§ñ';
            
            const content = document.createElement('div');
            content.className = 'message-content';
            content.innerHTML = formatResponse(message);

            // Add message actions for bot messages
            if (!isUser) {
                const actions = document.createElement('div');
                actions.className = 'message-actions';
                actions.innerHTML = `
                    <button class="action-btn" onclick="copyMessage(this)" title="Copia">üìã</button>
                `;
                content.appendChild(actions);
            }
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(content);
            
            if (!isUser && intent) {
              const meta = document.createElement('div');
              meta.className = 'message-meta';
    
              const intentSpan = document.createElement('span');
              intentSpan.textContent = `Intent: ${intent}`;
              meta.appendChild(intentSpan);
          
              // Show confidence badge only if confidence > 0
              if (confidence > 0) {
                  const confidenceSpan = document.createElement('span');
                  confidenceSpan.className = `confidence-badge ${getConfidenceClass(confidence)}`;
                  confidenceSpan.textContent = `${confidence}% confidence`;
                  meta.appendChild(confidenceSpan);
              }
          
              const timeSpan = document.createElement('span');
              timeSpan.textContent = new Date().toLocaleTimeString();
              meta.appendChild(timeSpan);
          
              content.appendChild(meta);      
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            messageCount++;
            updateStats();
        }

        // Copy message function - preserve formatting
        function copyMessage(btn) {
            const messageContent = btn.closest('.message-content');
            
            // Creates a temporary element to extract formatted text
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = messageContent.innerHTML;
            
            // Remove action buttons and metadata
            const actions = tempDiv.querySelector('.message-actions');
            if (actions) actions.remove();
            
            const meta = tempDiv.querySelector('.message-meta');
            if (meta) meta.remove();
            
            // Get clean text while maintaining basic formatting
            let textToCopy = tempDiv.textContent.trim();
            
            // Improves formatting for common items
            textToCopy = textToCopy
                .replace(/\*\*(.*?)\*\*/g, '$1') // Grassetto
                .replace(/\*(.*?)\*/g, '$1')     // Corsivo
                .replace(/<br\s*\/?>/gi, '\n')   // New lines
                .replace(/<[^>]*>/g, '');        // Altri tag HTML
            
            navigator.clipboard.writeText(textToCopy);
            showNotification('Messaggio copiato! üìã');
        }

        function showTyping() {
            document.getElementById('typingIndicator').style.display = 'flex';
        }

        function hideTyping() {
            document.getElementById('typingIndicator').style.display = 'none';
        }

        function setStatus(online) {
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');
            const statusDot = document.querySelector('.status-dot');
            
            if (online) {
                text.textContent = 'üü¢ Online';
                text.className = 'status-online';
                statusDot.style.background = '#28a745';
            } else {
                text.textContent = 'üî¥ Offline';
                text.className = 'status-offline';
                statusDot.style.background = '#dc3545';
            }
            
            indicator.style.display = 'block';
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 3000);
        }

        async function sendMessage(event) {
            event.preventDefault();
            
            const input = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Disable input
            input.disabled = true;
            sendButton.disabled = true;
            
            addMessage(message, true);
            input.value = '';
            
            showTyping();
            
            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message: message })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                hideTyping();
                
                addMessage(data.response, false, data.intent, data.confidence);
                setStatus(true);
                
            } catch (error) {
                hideTyping();
                addMessage('‚ùå Errore di connessione. Riprova tra poco.', false);
                setStatus(false);
                console.error('Error:', error);
                showNotification('‚ùå Errore di connessione');
            }
            
            // Re-enable input
            input.disabled = false;
            sendButton.disabled = false;
            input.focus();
        }

        function sendSuggestion(message) {
            document.getElementById('messageInput').value = message;
            sendMessage(new Event('submit'));
        }

        // Voice input function
        let isRecording = false;
        function toggleVoiceInput() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                showNotification('‚ùå Riconoscimento vocale non supportato');
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            
            if (isRecording) {
                recognition.stop();
                isRecording = false;
                showNotification('üé§ Registrazione interrotta');
                return;
            }

            recognition.lang = 'it-IT';
            recognition.continuous = false;
            recognition.interimResults = false;

            recognition.onstart = () => {
                isRecording = true;
                showNotification('üé§ Parla ora...');
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                document.getElementById('messageInput').value = transcript;
                showNotification('‚úÖ Messaggio trascritto!');
            };

            recognition.onerror = () => {
                showNotification('‚ùå Errore nel riconoscimento vocale');
            };

            recognition.onend = () => {
                isRecording = false;
            };

            recognition.start();
        }

        // Initialize everything
        document.addEventListener('DOMContentLoaded', function() {
            createParticles();
            loadTheme();
            updateStats();
            
            // Auto-focus input
            document.getElementById('messageInput').focus();

            // Handle Enter key
            document.getElementById('messageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage(e);
                }
            });

            // Show character count and styling
            document.getElementById('messageInput').addEventListener('input', function(e) {
                const length = e.target.value.length;
                if (length > 450) {
                    e.target.style.borderColor = '#dc3545';
                } else if (length > 300) {
                    e.target.style.borderColor = '#ffc107';
                } else {
                    e.target.style.borderColor = 'var(--border-color)';
                }
            });

            // Update session time every second
            setInterval(updateStats, 1000);

            // Load conversation history on page load
            loadHistory();

            // Health check every 30 seconds
            setInterval(checkHealth, 30000);

            // Handle orientation changes and resize
            window.addEventListener('resize', handleResize);
            window.addEventListener('orientationchange', () => {
                setTimeout(handleResize, 100);
            });
        });

        // Handle resize and orientation changes
        function handleResize() {
            // Force chat messages to recalculate height
            const chatMessages = document.getElementById('chatMessages');
            const container = document.querySelector('.container');
            
            // Small delay to ensure layout is updated
            setTimeout(() => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 100);
        }

        // Load conversation history
        async function loadHistory() {
            try {
                const response = await fetch('/history');
                const data = await response.json();
                
                // Only if there are conversations, show them
                if (data.history && data.history.length > 0) {
                    // Clear welcome message first
                    const chatMessages = document.getElementById('chatMessages');
                    chatMessages.innerHTML = '';
                    isFirstMessage = false;
                    
                    // Show recent conversation
                    data.history.reverse().forEach(conv => {
                        addMessage(conv.message, true);
                        addMessage(conv.response, false, conv.intent);
                    });
                }
                // If there are no conversations, leave the welcome message
            } catch (error) {
                console.log('No previous history available or error loading history');
            }
        }        

        // Health check
        async function checkHealth() {
            try {
                const response = await fetch('/health');
                if (response.ok) {
                    setStatus(true);
                }
            } catch (error) {
                setStatus(false);
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + L = Clear chat
            if ((e.ctrlKey || e.metaKey) && e.key === 'l') {
                e.preventDefault();
                clearChat();
            }
            
            // Ctrl/Cmd + D = Toggle dark mode
            if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
                e.preventDefault();
                toggleTheme();
            }
            
            // Esc = Clear input
            if (e.key === 'Escape') {
                document.getElementById('messageInput').value = '';
                document.getElementById('messageInput').focus();
            }
        });

        // Add some easter eggs
        let konamiCode = [];
        const konamiSequence = ['ArrowUp', 'ArrowUp', 'ArrowDown', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'ArrowLeft', 'ArrowRight', 'KeyB', 'KeyA'];

        document.addEventListener('keydown', function(e) {
            konamiCode.push(e.code);
            if (konamiCode.length > konamiSequence.length) {
                konamiCode.shift();
            }
            
            if (konamiCode.join(',') === konamiSequence.join(',')) {
                showNotification('üéâ Konami Code attivato! Easter egg sbloccato!');
                // Add rainbow effect
                document.body.style.filter = 'hue-rotate(0deg)';
                let hue = 0;
                const rainbowInterval = setInterval(() => {
                    hue += 1;
                    document.body.style.filter = `hue-rotate(${hue}deg)`;
                    if (hue >= 360) {
                        clearInterval(rainbowInterval);
                        document.body.style.filter = 'none';
                    }
                }, 10);
                konamiCode = [];
            }
        });

        // Right-click context menu for messages
        document.addEventListener('contextmenu', function(e) {
            if (e.target.closest('.message-content')) {
                e.preventDefault();
                showNotification('üí° Usa il pulsante üìã per copiare!');
            }
        });

        // Double-click to quick copy message
        document.addEventListener('dblclick', function(e) {
            if (e.target.closest('.message.bot')) {
                const messageContent = e.target.closest('.message-content').textContent;
                navigator.clipboard.writeText(messageContent.replace(/üìã.*/, '').trim());
                showNotification('üìã Messaggio copiato con doppio click!');
            }
        });
    </script>
</body>
</html>